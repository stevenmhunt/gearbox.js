/* gearbox.js
 * version 0.1
 * written by Steven Hunt
 * released under the MIT License. */
 
var gearbox=gearbox||{version:"0.2"};(function(e){var t=function(e,t,n,r){this.interval=e!==undefined?e:1e3;if(t===undefined)this.threshold={increment:{delay_above:50,duration:1}};else if(isNaN(t))this.threshold=t;else this.threshold={increment:{delay_above:t,duration:1}};if(n!==undefined&&r===undefined){r=n;n=1}this.top=r!==undefined?r:10;var i=n!==undefined?n:1;this.currentGear=function(){return i};var s={shift:new Array};this.on=function(e,t){if(!s.hasOwnProperty(e))s[e]=new Array;s[e].push(t)};this.trigger=function(e,t){if(!s.hasOwnProperty(e))return false;for(var n=0;n<s[e].length;n++){s[e][n].apply(this,t)}return true};this.shiftUp=function(){if(i>=this.top)return false;i++;this.trigger("shift");return true};this.shiftDown=function(){if(i<=1)return false;i--;this.trigger("shift");return true};var o=0;var u=0;var a=0;this.performance=function(){return u};this.status="stopped";var f=this;var l=function(){var e=[f.threshold.increment instanceof Array?f.threshold.increment:new Array(f.threshold.increment),f.threshold.decrement instanceof Array?f.threshold.decrement:new Array(f.threshold.decrement)];for(var t=0;t<e.length;t++){if(e[t]===undefined)continue;for(var n=0;n<e[t].length;n++){var r=e[t][n];if(r===undefined)continue;if(r.delay_above&&u>r.delay_above||r.delay_below&&u<r.delay_below){a++;if(!r.duration||a>=r.duration){if(t==0)f.shiftUp();else f.shiftDown()}return}}}};var c=null;var h=function(){if(f.status=="stopped")return;setTimeout(c,f.interval)};c=function(){var e=(new Date).getTime();if(o>0){u=e-o-f.interval;l()}o=e;h()};this.start=function(){if(this.status=="started")return false;this.status="started";h();return true};this.stop=function(){this.status="stopped"};this.start()};instances={};var n=function(e){var t=document.cookie.split("; ");for(var n=0;n<t.length;n++){var r=t[n].split("=");if(unescape(r[0])==e)return unescape(r[1])}return null};var r=function(e,t,n){var r=new Date;r.setDate(r.getDate()+n);var i=escape(e);var s=escape(t)+(n==null?"":"; expires="+r.toUTCString());document.cookie=i+"="+s};e.get=function(e){if(!instances.hasOwnProperty(e))return false;return instances[e]};e.create=function(e,r,i,s,o){if(instances.hasOwnProperty(e))return false;var u=n("gearbox_js_"+e);if(u)s=u;instances[e]=new t(r,i,s,o);return instances[e]};e.create("default");e.destroy=function(e){if(!instances.hasOwnProperty(e))return false;instances[e].stop();delete instances[e];return true};e.save=function(e){if(e===undefined){var t=Object.keys(instances);for(var n=0;n<t.length;n++){r("gearbox_js_"+t[n],instances[t[n]].currentGear(),7)}}else if(instances.hasOwnProperty(e)){r("gearbox_js_"+e,instances[e].currentGear(),7)}};var i=function(e){var t={};var n=Object.keys(instances);for(var r=0;r<n.length;r++){var i=instances[n[r]];t[n[r]]=i[e]()}return t};e.all={start:function(){return i("start")},stop:function(){return i("stop")},shiftUp:function(){return i("shiftUp")},shiftDown:function(){return i("shiftDown")},performance:function(){return i("performance")},currentGear:function(){return i("currentGear")}}})(gearbox)